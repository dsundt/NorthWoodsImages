<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>NorthWoodsImages — Photo Processor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --brand:#8B1E24; --accent:#2E4A3B; --muted:#64748b; --line:#e2e8f0; --ink:#0f172a; --paper:#ffffff; --wash:#f8fafc; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--wash);color:var(--ink)}
    header{background:var(--paper);border-bottom:2px solid var(--brand);padding:12px 20px}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    fieldset{border:1px solid var(--line);border-radius:8px;margin-bottom:16px;background:var(--paper)}
    legend{padding:0 8px;color:#334155}
    label{display:block;margin:10px 0 6px;font-size:14px}
    input[type="text"],input[type="password"],input[type="file"],select{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){ .grid.two{grid-template-columns:1fr 1fr} }
    .btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .status{background:var(--paper);border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:16px;white-space:pre-wrap}
    .links a{display:block;margin:4px 0;color:#0ea5e9;text-decoration:none}
    .links a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px}
    .danger{color:#b91c1c}
    .ok{color:#15803d}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
    .note{background:#fffbeb;border:1px solid #f59e0b;color:#92400e;padding:8px;border-radius:8px;margin:8px 0}
  </style>
</head>
<body>
<header><h1>NorthWoodsImages — Photo Processor</h1></header>
<div class="wrap">
  <p class="muted">Runs entirely in your browser. Your GitHub token is sent only to GitHub’s API to upload files, start the workflow, and fetch artifacts.</p>

  <form id="form">
    <fieldset>
      <legend>GitHub</legend>
      <div class="grid two">
        <div>
          <label>Owner (username or org)</label>
          <input id="owner" type="text" placeholder="your-username" required>
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" type="text" value="NorthWoodsImages" required>
        </div>
      </div>
      <label>Personal Access Token (fine-grained, <span class="small">Contents RW + Workflows RW</span>)</label>
      <input id="token" type="password" placeholder="github_pat_..." required>
      <p class="muted">Create at Settings → Developer settings → Personal access tokens → Fine-grained tokens. Scope to this repo with Contents: Read/Write and Workflows: Read/Write.</p>
    </fieldset>

    <fieldset>
      <legend>Inputs</legend>
      <label>Images ZIP <span class="muted">(recommend &lt;= 95 MB)</span></label>
      <input id="zip" type="file" accept=".zip" required>
      <label>Logo (watermark)</label>
      <input id="logo" type="file" accept="image/*" required>
      <div class="grid two">
        <div>
          <label>Optional: captions.csv</label>
          <input id="captions" type="file" accept=".csv">
        </div>
        <div>
          <label>Optional: order.txt</label>
          <input id="order" type="file" accept=".txt">
        </div>
      </div>
      <div class="note small">Files are committed to: <code>input/uploads/&lt;timestamp&gt;/</code> to avoid overwrites (no SHA needed).</div>
    </fieldset>

    <fieldset>
      <legend>Brand & Property</legend>
      <div class="grid two">
        <div>
          <label>Property name</label>
          <input id="property" type="text" value="The Landmark" required>
        </div>
        <div>
          <label>Brand name</label>
          <input id="brand" type="text" value="Red Canoe Lodging" required>
        </div>
      </div>
      <div class="grid two">
        <div>
          <label>Brand email</label>
          <input id="email" type="text" value="info@redcanoelodging.com" required>
        </div>
        <div>
          <label>Brand phone</label>
          <input id="phone" type="text" value="715-351-9687" required>
        </div>
      </div>
      <label>Brand website</label>
      <input id="site" type="text" value="redcanoelodging.com" required>
      <label>Max web width (px)</label>
      <input id="maxw" type="text" value="2560" required>
    </fieldset>

    <div class="btn-row">
      <button id="run" class="btn" type="submit">Upload & Run Workflow</button>
      <button id="reset" type="button">Reset</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill">Triggers: <code>Build and Deploy Landmark Photos</code></span>
      <span class="pill">Outputs: PDF, HTML, caption list, full/web ZIPs</span>
    </div>
  </form>

  <div id="out" class="status" style="display:none"></div>
  <div id="links" class="links" style="display:none"></div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const out=$("out"), links=$("links"), btn=$("run"), reset=$("reset");
  const show = (el)=>el.style.display="block";
  const hide = (el)=>el.style.display="none";
  const log = (msg, cls="")=>{ show(out); out.innerHTML += `\n${cls?`[${cls}] `:""}${msg}`; out.scrollTop = out.scrollHeight; };

  // Size check guard for GitHub Contents API and browser memory
  const MAX_SAFE_UPLOAD = 95 * 1024 * 1024; // ~95 MB

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const res = reader.result || "";
        const idx = res.indexOf(",");
        resolve(idx>=0 ? res.slice(idx+1) : res);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function gh(method, url, token, body, isJson=true){
    const headers = { "Authorization":"Bearer "+token, "Accept":"application/vnd.github+json" };
    const res = await fetch(url, {
      method,
      headers,
      body: body ? (isJson ? JSON.stringify(body) : body) : undefined
    });
    if(!res.ok){
      let t = await res.text();
      throw new Error(`${res.status} ${res.statusText}: ${t}`);
    }
    if(!isJson) return res;
    // GitHub may return 204 No Content (e.g., workflow dispatch). Avoid parsing empty bodies.
    if(res.status === 204) return null;
    const contentLength = res.headers.get("content-length");
    if(contentLength === "0") return null;
    const text = await res.text();
    if(!text) return null;
    try{ return JSON.parse(text); }catch(_){ return null; }
  }

  async function uploadContent(owner, repo, token, path, file){
    if(file.size > MAX_SAFE_UPLOAD){
      throw new Error(`File too large for browser/API upload (${(file.size/1024/1024).toFixed(1)} MB). Use git commit, LFS, or split uploads.`);
    }
    const content = await fileToBase64(file);
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    return gh("PUT", url, token, { message:`Add ${path} via UI`, content });
  }

  async function dispatchWorkflow(owner, repo, token, inputs){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/build.yml/dispatches`;
    return gh("POST", url, token, { ref:"main", inputs });
  }

  async function listRuns(owner, repo, token){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs?event=workflow_dispatch&per_page=5`;
    return gh("GET", url, token);
  }

  async function getRun(owner, repo, token, id){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${id}`;
    return gh("GET", url, token);
  }

  async function getArtifacts(owner, repo, token, runId){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/artifacts`;
    return gh("GET", url, token);
  }

  async function downloadArtifact(owner, repo, token, artifact){
    // Fetch artifact ZIP and trigger client-side download
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${artifact.id}/zip`;
    const res = await gh("GET", url, token, null, false);
    const blob = await res.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${artifact.name}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    a.remove();
  }

  async function run(e){
    e.preventDefault();
    out.textContent=""; hide(links); show(out); btn.disabled = true;

    try{
      const owner = $("owner").value.trim();
      const repo  = $("repo").value.trim();
      const token = $("token").value.trim();
      const fzip  = $("zip").files[0];
      const flogo = $("logo").files[0];
      const fcaps = $("captions").files[0] || null;
      const fordr = $("order").files[0] || null;
      if(!owner || !repo || !token || !fzip || !flogo) throw new Error("Missing required fields.");

      if(fzip.size > MAX_SAFE_UPLOAD){
        log(`ZIP is ${(fzip.size/1024/1024).toFixed(1)} MB > ~95 MB browser/API limit.`, "ERROR");
        throw new Error("Please split or commit via Git.");
      }

      const ts = new Date().toISOString().replace(/[:.]/g,"-");
      const base = `input/uploads/${ts}`;
      const zipPath = `${base}/${fzip.name}`;
      const logoPath= `${base}/${flogo.name}`;
      const capsPath= fcaps ? `${base}/${fcaps.name}` : "";
      const ordPath = fordr ? `${base}/${fordr.name}` : "";

      log("Uploading files to repo …");
      await uploadContent(owner, repo, token, zipPath, fzip);
      await uploadContent(owner, repo, token, logoPath, flogo);
      if(fcaps) await uploadContent(owner, repo, token, capsPath, fcaps);
      if(fordr) await uploadContent(owner, repo, token, ordPath, fordr);
      log("Uploads complete.", "OK");

      const inputs = {
        property_name: $("property").value,
        brand_name: $("brand").value,
        brand_email: $("email").value,
        brand_phone: $("phone").value,
        brand_site: $("site").value,
        zip_file: zipPath,
        logo_file: logoPath,
        captions_csv: capsPath,
        order_file: ordPath,
        max_web_width: $("maxw").value
      };

      log("Dispatching workflow …");
      await dispatchWorkflow(owner, repo, token, inputs);
      log("Workflow started. Waiting for run to register …");

      let run = null, attempts = 0;
      while(!run && attempts < 30){
        await new Promise(r=>setTimeout(r, 3000));
        const runs = await listRuns(owner, repo, token);
        if(runs.workflow_runs && runs.workflow_runs.length){
          run = runs.workflow_runs[0];
        }
        attempts++;
      }
      if(!run) throw new Error("Could not find a workflow run. Check Actions tab.");

      log(`Run ID: ${run.id}. Polling status …`);
      while(true){
        await new Promise(r=>setTimeout(r, 5000));
        const cur = await getRun(owner, repo, token, run.id);
        log(`Status: ${cur.status} / Conclusion: ${cur.conclusion || "…"}`);
        if(cur.status === "completed"){
          run = cur;
          break;
        }
      }

      if(run.conclusion !== "success"){
        log("Workflow did not succeed. See Actions logs.", "ERROR");
        show(links);
        const a = document.createElement("a");
        a.href = `https://github.com/${owner}/${repo}/actions/runs/${run.id}`;
        a.target = "_blank";
        a.textContent = "Open run logs";
        links.appendChild(a);
        return;
      }

      log("Success. Fetching artifacts …", "OK");
      const arts = await getArtifacts(owner, repo, token, run.id);
      show(links);
      links.innerHTML = "<h3>Downloads</h3>";

      const pagesUrl = `https://${owner}.github.io/${repo}/`;
      const lnk = document.createElement("a");
      lnk.href = pagesUrl;
      lnk.textContent = "Open GitHub Pages output";
      lnk.target = "_blank";
      links.appendChild(lnk);

      (arts.artifacts || []).forEach(a=>{
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = `Download ${a.name}.zip`;
        btn.onclick = ()=>downloadArtifact(owner, repo, token, a);
        links.appendChild(btn);
      });

      log("All done. You can also open the Pages site for HTML outputs.", "OK");
    }catch(err){
      log(`Error: ${err.message}`, "ERROR");
      console.error(err);
    }finally{
      btn.disabled = false;
    }
  }

  function doReset(){
    $("form").reset();
    out.textContent = "";
    hide(out); hide(links);
  }

  $("form").addEventListener("submit", run);
  reset.addEventListener("click", doReset);

  // Prefill owner if served from GitHub Pages
  try{
    const host = location.hostname;
    if(host.endsWith(".github.io")){
      $("owner").value = host.replace(".github.io","");
    }
  }catch(e){}
})();
</script>
</body>
</html>
