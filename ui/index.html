<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>NorthWoodsImages — Photo Processor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    header{background:#fff;border-bottom:2px solid #8B1E24;padding:12px 20px}
    h1{margin:0;font-size:20px}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    fieldset{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:16px;background:#fff}
    legend{padding:0 8px;color:#334155}
    label{display:block;margin:10px 0 6px;font-size:14px}
    input[type="text"],input[type="password"],input[type="file"],select{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .btn{background:#2E4A3B;color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:#64748b;font-size:12px}
    .status{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-top:16px}
    .links a{display:block;margin:4px 0;color:#0ea5e9;text-decoration:none}
    .links a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 10px;font-size:12px}
    .danger{color:#b91c1c}
  </style>
</head>
<body>
<header><h1>NorthWoodsImages — Photo Processor</h1></header>
<div class="wrap">
  <p class="muted">This page runs entirely in your browser. Your GitHub token is used only for API calls from your device to GitHub.</p>

  <form id="form">
    <fieldset>
      <legend>GitHub</legend>
      <div class="grid">
        <div>
          <label>Owner (username or org)</label>
          <input id="owner" type="text" placeholder="your-username" required>
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" type="text" value="NorthWoodsImages" required>
        </div>
      </div>
      <label>Personal Access Token (fine-grained with <code>contents</code> and <code>workflows</code> scopes)</label>
      <input id="token" type="password" placeholder="ghp_..." required>
      <p class="muted">Tip: Create a temporary fine-grained token limited to this repo, with <strong>Contents: Read/Write</strong> and <strong>Workflows: Read/Write</strong>.</p>
    </fieldset>

    <fieldset>
      <legend>Inputs</legend>
      <label>Images ZIP</label>
      <input id="zip" type="file" accept=".zip" required>
      <label>Logo (watermark)</label>
      <input id="logo" type="file" accept="image/*" required>
      <div class="grid">
        <div>
          <label>Optional: captions.csv</label>
          <input id="captions" type="file" accept=".csv">
        </div>
        <div>
          <label>Optional: order.txt</label>
          <input id="order" type="file" accept=".txt">
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Brand & Property</legend>
      <div class="grid">
        <div>
          <label>Property name</label>
          <input id="property" type="text" value="The Landmark" required>
        </div>
        <div>
          <label>Brand name</label>
          <input id="brand" type="text" value="Red Canoe Lodging" required>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Brand email</label>
          <input id="email" type="text" value="info@redcanoelodging.com" required>
        </div>
        <div>
          <label>Brand phone</label>
          <input id="phone" type="text" value="715-351-9687" required>
        </div>
      </div>
      <label>Brand website</label>
      <input id="site" type="text" value="redcanoelodging.com" required>
      <label>Max web width (px)</label>
      <input id="maxw" type="text" value="2560" required>
    </fieldset>

    <button id="run" class="btn" type="submit">Upload & Run Workflow</button>
    <div class="row" style="margin-top:8px">
      <span class="pill">Uploads → <code>input/uploads/&lt;timestamp&gt;/</code></span>
      <span class="pill">Triggers Action: <code>Build and Deploy Landmark Photos</code></span>
    </div>
  </form>

  <div id="out" class="status" style="display:none"></div>
  <div id="links" class="links" style="display:none"></div>
</div>

<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const out = $("out"); const links = $("links");
  const show = (el)=>{el.style.display="block";}; const hide=(el)=>{el.style.display="none";};
  const log = (msg, cls="") => { show(out); out.innerHTML += `<div class="${cls}">${msg}</div>`; };

  const b64 = (arrbuf)=> btoa(String.fromCharCode(...new Uint8Array(arrbuf)));

  async function gh(method, url, token, body){
    const res = await fetch(url, {
      method,
      headers: {
        "Authorization": "Bearer " + token,
        "Accept": "application/vnd.github+json"
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`${res.status} ${res.statusText}: ${t}`);
    }
    return res.json();
  }

  async function uploadContent(owner, repo, token, path, file) {
    const ab = await file.arrayBuffer();
    const content = b64(ab);
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    return gh("PUT", url, token, {
      message: `Add ${path} via UI`,
      content
    });
  }

  async function dispatchWorkflow(owner, repo, token, inputs) {
    // workflow filename MUST match your repo
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/build.yml/dispatches`;
    return gh("POST", url, token, {
      ref: "main",
      inputs
    });
  }

  async function getLatestRun(owner, repo, token) {
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs?event=workflow_dispatch&per_page=1`;
    const j = await gh("GET", url, token);
    return j.workflow_runs && j.workflow_runs.length ? j.workflow_runs[0] : null;
  }

  async function getRun(owner, repo, token, runId){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}`;
    return gh("GET", url, token);
  }

  async function getArtifacts(owner, repo, token, runId){
    const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/artifacts`;
    return gh("GET", url, token);
  }

  $("form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hide(links); out.innerHTML=""; show(out);
    $("run").disabled = true;

    try{
      const owner = $("owner").value.trim();
      const repo  = $("repo").value.trim();
      const token = $("token").value.trim();
      const fzip  = $("zip").files[0];
      const flogo = $("logo").files[0];
      const fcaps = $("captions").files[0] || null;
      const fordr = $("order").files[0] || null;

      if(!owner || !repo || !token || !fzip || !flogo){ throw new Error("Missing required fields."); }

      const ts = new Date().toISOString().replace(/[:.]/g,"-");
      const zipPath = `input/uploads/${ts}/${fzip.name}`;
      const logoPath= `input/uploads/${ts}/${flogo.name}`;
      const capsPath= fcaps ? `input/uploads/${ts}/${fcaps.name}` : "";
      const ordPath = fordr ? `input/uploads/${ts}/${fordr.name}` : "";

      log("Uploading files to repo …");
      await uploadContent(owner, repo, token, zipPath, fzip);
      await uploadContent(owner, repo, token, logoPath, flogo);
      if(fcaps) await uploadContent(owner, repo, token, capsPath, fcaps);
      if(fordr) await uploadContent(owner, repo, token, ordPath, fordr);
      log("Uploads complete.");

      const inputs = {
        property_name: $("property").value,
        brand_name: $("brand").value,
        brand_email: $("email").value,
        brand_phone: $("phone").value,
        brand_site: $("site").value,
        zip_file: zipPath,
        logo_file: logoPath,
        captions_csv: capsPath,
        order_file: ordPath,
        max_web_width: $("maxw").value
      };

      log("Dispatching workflow …");
      await dispatchWorkflow(owner, repo, token, inputs);
      log("Workflow started. Polling status …");

      let run = null;
      // Wait for the run to appear
      for(let i=0;i<30;i++){
        await new Promise(r=>setTimeout(r, 3000));
        run = await getLatestRun(owner, repo, token);
        if(run) break;
      }
      if(!run) throw new Error("Could not find a workflow run. Check Actions tab.");

      // Poll until completed
      while(true){
        await new Promise(r=>setTimeout(r, 5000));
        const cur = await getRun(owner, repo, token, run.id);
        log(`Status: ${cur.status} — Conclusion: ${cur.conclusion || "…"}`);
        if(cur.status === "completed"){
          run = cur;
          break;
        }
      }

      if(run.conclusion !== "success"){
        log("Workflow did not succeed. See Actions logs.", "danger");
        return;
      }

      // Fetch artifacts
      log("Fetching artifacts …");
      const arts = await getArtifacts(owner, repo, token, run.id);
      show(links); links.innerHTML = "<h3>Downloads</h3>";
      const pagesUrl = `https://${owner}.github.io/${repo}/`;
      links.innerHTML += `<a href="${pagesUrl}" target="_blank">View GitHub Pages output</a>`;
      (arts.artifacts || []).forEach(a=>{
        // download_url requires API fetch with token; we'll present the API link
        const dl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${a.id}/zip`;
        const anchor = document.createElement("a");
        anchor.href = dl;
        anchor.textContent = `Artifact: ${a.name}`;
        anchor.target = "_blank";
        anchor.rel = "noopener";
        links.appendChild(anchor);
      });

      log("Done. You can also check the Pages site for HTML outputs.");
    } catch(err){
      log("Error: " + err.message, "danger");
      console.error(err);
    } finally {
      $("run").disabled = false;
    }
  });

  // Prefill owner if page is being served from GitHub Pages
  try{
    const host = location.hostname;
    if(host.endsWith(".github.io")){
      const owner = host.replace(".github.io",""); $("owner").value = owner;
    }
  }catch(e){}
})();
</script>
</html>
